<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAI's Tech Log - ✨ 最終完美版</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script>

    <style>
        /* [VISUAL-FIX] 全局顏色與設計系統優化 */
        :root{--bg-color:#f9f9fb;--text-color:#1d1d1f;--text-secondary-color:#6e6e73;--primary-color:#0071e3;--accent-color:#ff8c00;--border-color:#d2d2d7;--card-bg:#ffffff;--shadow-color:rgba(0,0,0,0.08);--code-bg:#f5f5f7;--danger-color:#ff3b30;--like-color:#ff3b30;--icon-color:var(--text-secondary-color);--radius-large:20px;--radius-medium:15px;--radius-small:10px;--header-height:60px}
        body.dark-mode{--bg-color:#000000;--text-color:#f5f5f7;--text-secondary-color:#8e8e93;--primary-color:#2997ff;--accent-color:#ff9500;--border-color:#3a3a3c;--card-bg:#1c1c1e;--shadow-color:rgba(0,0,0,0.4);--code-bg:#2c2c2e;--icon-color:var(--text-secondary-color)}
        *{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}
        body{background-color:var(--bg-color);color:var(--text-color);font-family:-apple-system,BlinkMacSystemFont,"SF Pro TC","蘋方-繁","PingFang TC","Segoe UI",Helvetica,Arial,sans-serif;line-height:1.7;transition:background-color .4s,color .4s}
        .btn{border:none;padding:10px 20px;border-radius:var(--radius-medium);cursor:pointer;font-weight:600;font-size:.9rem;transition:transform .2s,box-shadow .2s,background-color .2s;display:flex;align-items:center;justify-content:center;gap:8px}.btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.15)}.btn:active{transform:translateY(-1px) scale(.98)}
        .btn-primary{background:var(--primary-color);color:white}
        .btn-danger{background-color:var(--danger-color);color:white}
        .site-header{position:sticky;top:0;z-index:100;padding:0 5%;background-color:rgba(var(--bg-color),.8);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid var(--border-color)}
        .header-content{display:flex;justify-content:space-between;align-items:center;height:var(--header-height);padding:10px 0;max-width:1280px;margin:0 auto;gap:15px}
        .site-title{font-size:1.6rem;font-weight:700;cursor:pointer;color:var(--primary-color);letter-spacing:-.5px}
        .header-controls{display:flex;align-items:center;gap:15px}
        .controls{display:flex;align-items:center;gap:10px}
        .control-group{position:relative}
        .control-btn{background-color:var(--code-bg);border:1px solid var(--border-color);color:var(--text-color);padding:8px 16px;border-radius:var(--radius-medium);cursor:pointer;font-weight:500;font-size:.9rem;display:flex;align-items:center;gap:6px}
        .control-dropdown{display:none;position:absolute;top:calc(100% + 5px);right:0;min-width:180px;background-color:var(--card-bg);border:1px solid var(--border-color);border-radius:var(--radius-large);z-index:110;padding:8px;box-shadow:0 8px 30px var(--shadow-color);animation:popIn .2s ease-out}@keyframes popIn{from{opacity:0;transform:scale(.95) translateY(-10px)}to{opacity:1;transform:scale(1) translateY(0)}}
        .control-dropdown.active{display:block}
        .dropdown-item{display:block;width:100%;text-align:left;padding:10px 15px;border:none;background:none;color:var(--text-color);cursor:pointer;border-radius:var(--radius-small)}.dropdown-item:hover,.dropdown-item.active{background-color:var(--primary-color);color:white}
        .search-input{width:180px;padding:8px 15px;border-radius:var(--radius-medium);border:1px solid var(--border-color);background-color:var(--code-bg);color:var(--text-color);font-size:.9rem}
        .theme-toggle{cursor:pointer;font-size:1.5rem;display:grid;place-items:center;color:var(--text-color)}
        #new-article-btn{display:none}
        body.edit-mode #new-article-btn{display:flex}
        main{padding:40px 5%;min-height:calc(100vh - var(--header-height) - 70px);max-width:1280px;margin:0 auto}
        .view{display:none}.view.active{display:block;animation:fadeIn .6s ease-in-out}@keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
        .article-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:35px}
        .article-card{background-color:var(--card-bg);border-radius:var(--radius-large);box-shadow:0 4px 25px var(--shadow-color);transition:transform .3s ease,box-shadow .3s ease;position:relative;display:flex;flex-direction:column;opacity:0;animation:fadeIn .5s ease forwards}
        .article-card:hover{transform:translateY(-10px);box-shadow:0 15px 45px var(--shadow-color)}
        .card-cover-image{width:100%;aspect-ratio:16/10;object-fit:cover;background-color:var(--border-color);cursor:pointer;border-radius:var(--radius-large) var(--radius-large) 0 0}
        .card-content{padding:25px;cursor:pointer;flex-grow:1}
        .card-title{font-size:1.3rem;font-weight:600;margin-bottom:12px;color:var(--text-color)}
        .card-footer{padding:0 25px 20px;display:flex;justify-content:space-between;align-items:center;color:var(--text-secondary-color);font-size:.9rem;flex-wrap:wrap;gap:5px 15px}
        .card-meta-item{display:flex;align-items:center;gap:8px;color:var(--icon-color)}
        .like-btn{cursor:pointer;transition:color .2s}.like-btn.liked{color:var(--like-color)}
        @keyframes like-beat{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}.like-btn.beating{animation:like-beat .3s ease-in-out}
        .card-edit-btn{position:absolute;top:15px;right:15px;background-color:rgba(255,149,0,.8);color:white;border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;z-index:5;backdrop-filter:blur(5px);display:none;place-items:center}
        body.edit-mode .card-edit-btn{display:grid}
        .article-container{max-width:800px;margin:0 auto;padding-bottom:50px}
        .article-header-image{width:100%;aspect-ratio:21/9;object-fit:cover;border-radius:var(--radius-large);margin-bottom:30px;background-color:var(--border-color)}
        .article-title{font-size:2.8rem;font-weight:700;line-height:1.2;margin-bottom:15px}
        .article-meta{color:var(--text-secondary-color);margin-bottom:30px;font-size:.95rem;display:flex;flex-wrap:wrap;gap:8px 25px;align-items:center}
        .article-meta span{display:flex;align-items:center;gap:8px}
        .article-content{font-size:1.1rem;line-height:1.8}
        .article-content h2{margin-top:2em;margin-bottom:1em;border-bottom:2px solid var(--border-color);padding-bottom:.3em}
        .article-content code{background-color:var(--code-bg);padding:.2em .4em;margin:0;font-size:85%;border-radius:var(--radius-small)}
        .article-content pre>code{padding:1em;display:block;overflow-x:auto}
        .interaction-bar{margin:40px 0;display:flex;align-items:center;gap:20px;border-top:1px solid var(--border-color);border-bottom:1px solid var(--border-color);padding:15px 0}
        .comments-section{margin-top:50px}
        #comment-form input,#comment-form textarea{width:100%;padding:12px;border-radius:var(--radius-medium);border:1px solid var(--border-color);background-color:var(--code-bg);color:var(--text-color);font-size:1rem;margin-bottom:10px}
        #comment-list .comment{display:flex;gap:15px;padding:15px 0;border-bottom:1px solid var(--border-color)}
        #comment-list .comment:first-child{padding-top:0}
        .comment-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;background-color:var(--border-color)}
        .comment-body{flex-grow:1}
        .comment-author{font-weight:600;color:var(--text-color)}
        .comment-text{color:var(--text-secondary-color);word-break:break-word}
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000;display:none;align-items:center;justify-content:center;animation:fadeIn .3s}
        .overlay.active{display:flex}
        /* [UX-FIX] Editor Modal redesign */
        #editor-modal{width:95%;max-width:1100px;height:90vh}
        #editor-modal .modal-body{display:flex;gap:20px;padding:15px}
        #editor-modal .editor-meta{width:300px;flex-shrink:0}
        #editor-modal .editor-main{flex-grow:1;display:flex;flex-direction:column}
        #editor-modal input{width:100%;padding:12px;border-radius:var(--radius-medium);border:1px solid var(--border-color);background-color:var(--bg-color);color:var(--text-color);font-size:1rem;margin-bottom:15px}
        .EasyMDEContainer{flex-grow:1;display:flex;flex-direction:column;border:1px solid var(--border-color);border-radius:var(--radius-medium)}
        .CodeMirror{flex-grow:1;border-radius:0 0 var(--radius-medium) var(--radius-medium)}
        .modal-footer{padding:15px;border-top:1px solid var(--border-color);display:flex;justify-content:space-between;gap:10px}
        .loader{text-align:center;padding:50px;color:var(--text-secondary-color)}
        .site-footer{padding:40px 5%;text-align:center;color:var(--text-secondary-color);border-top:1px solid var(--border-color);margin-top:30px;cursor:default;transition:margin-bottom .3s}
        /* [UX-FIX] Smarter Bottom Navigation Bar */
        .article-bottom-nav{display:none}
        @media (max-width: 768px) {
            .article-bottom-nav.active{display:flex;position:fixed;bottom:0;left:0;width:100%;background-color:rgba(var(--card-bg),.8);backdrop-filter:blur(10px);border-top:1px solid var(--border-color);justify-content:space-between;align-items:center;padding:15px 5%;z-index:200;animation:fadeIn .3s}
            body.bottom-nav-active .site-footer { margin-bottom: 80px; }
        }
        @media (min-width: 769px) {
            .article-bottom-nav.active{display:flex;justify-content:space-between;margin-top:50px;border-top:1px solid var(--border-color);padding-top:30px}
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-content">
            <div id="site-title" class="site-title">✨ Kai's Tech Log</div>
            <div class="header-controls">
                <div class="search-box"><input type="search" id="search-input" class="search-input" placeholder="搜尋..."></div>
                <div id="top-controls" class="controls">
                    <button id="new-article-btn" class="btn btn-primary"><i class="fas fa-plus"></i> 新增</button>
                    <div class="control-group">
                        <button id="sort-display-btn" class="control-btn">排序 ▼</button>
                        <div id="sort-dropdown" class="control-dropdown"></div>
                    </div>
                    <div class="control-group">
                        <button id="category-display-btn" class="control-btn">分類 ▼</button>
                        <div id="category-dropdown" class="control-dropdown"></div>
                    </div>
                </div>
                <div class="theme-toggle" id="theme-toggle">☀️</div>
            </div>
        </div>
    </header>

    <main>
        <div id="home-view" class="view active">
            <div id="loader" class="loader"><p>正在從雲端載入資料...</p></div>
            <div class="article-grid" id="article-grid"></div>
        </div>
        <div id="article-view" class="view"></div>
    </main>
    
    <!-- [UX-FIX] Bottom nav is now just a container, logic handles display -->
    <nav id="article-bottom-nav" class="article-bottom-nav"></nav>

    <!-- [UX-FIX] Editor Modal Reworked -->
    <div id="editor-overlay" class="overlay">
        <div id="editor-modal" class="modal">
            <div class="modal-header">
                <span id="editor-modal-title">編輯文章</span>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="editor-meta">
                    <input type="hidden" id="editor-id">
                    <label for="editor-title">標題</label>
                    <input type="text" id="editor-title" placeholder="文章標題">
                    <label for="editor-category">分類</label>
                    <input type="text" id="editor-category" placeholder="文章分類">
                    <label for="editor-cover-image">封面圖片</label>
                    <input type="text" id="editor-cover-image" placeholder="圖片 URL">
                </div>
                <div class="editor-main">
                    <label for="editor-content">內容 (Markdown)</label>
                    <textarea id="editor-content"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="delete-btn" class="btn btn-danger"><i class="fas fa-trash"></i> 刪除</button>
                <button id="save-btn" class="btn btn-primary"><i class="fas fa-save"></i> 儲存發布</button>
            </div>
        </div>
    </div>
    
    <footer id="site-footer" class="site-footer">
        <p>© 2024 Kai's Tech Log. (連續點擊此處進入管理模式)</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, get, remove, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAKiC62bh50NXLMWwbfNHekmVCBtTtam6Y",
          authDomain: "blog-63ad2.firebaseapp.com",
          databaseURL: "https://blog-63ad2-default-rtdb.firebaseio.com",
          projectId: "blog-63ad2",
          storageBucket: "blog-63ad2.appspot.com",
          messagingSenderId: "265914768921",
          appId: "1:265914768921:web:e4c752780e604d0be69488"
        };
        
        const SITE_URL = "https://kaihchs118.github.io/kaistudio/";

        let appState = { articles: {}, allCategories: [], isEditMode: false, currentFilter: 'All', currentSort: 'newest', sortedArticleIds: [] };
        initializeApp(firebaseConfig);
        const db = getDatabase();
        
        const ui = {
            body: document.body, loader: document.getElementById('loader'), articleGrid: document.getElementById('article-grid'),
            homeView: document.getElementById('home-view'), articleView: document.getElementById('article-view'),
            topControls: document.getElementById('top-controls'),
            sortDisplayBtn: document.getElementById('sort-display-btn'), sortDropdown: document.getElementById('sort-dropdown'),
            catDisplayBtn: document.getElementById('category-display-btn'), catDropdown: document.getElementById('category-dropdown'),
            siteTitle: document.getElementById('site-title'), searchInput: document.getElementById('search-input'), themeToggle: document.getElementById('theme-toggle'),
            newArticleBtn: document.getElementById('new-article-btn'),
            editorOverlay: document.getElementById('editor-overlay'), editorId: document.getElementById('editor-id'), editorTitle: document.getElementById('editor-title'),
            editorCategory: document.getElementById('editor-category'), editorCoverImage: document.getElementById('editor-cover-image'), editorContent: document.getElementById('editor-content'),
            saveBtn: document.getElementById('save-btn'), deleteBtn: document.getElementById('delete-btn'),
            footer: document.getElementById('site-footer'), articleBottomNav: document.getElementById('article-bottom-nav')
        };
        let easyMDE;
        const DEFAULT_IMG_URL = 'https://i.imgur.com/g22yT3s.png';

        async function loadInitialData() {
            ui.loader.style.display = 'block';
            try {
                const articlesSnapshot = await get(ref(db, 'blogData/articles'));
                appState.articles = articlesSnapshot.exists() ? articlesSnapshot.val() : {};
                filterAndSort();
                renderCategories();
                renderSortOptions();
            } catch (error) {
                console.error("Firebase data loading failed:", error);
                ui.loader.innerHTML = `<p style="color:red;"><b>資料載入失敗！</b><br>請確認 Firebase 資料庫規則已設定正確。<br>(${error.message})</p>`;
            } finally {
                ui.loader.style.display = 'none';
            }
        }

        function filterAndSort(searchTerm = '') {
            const lowerCaseSearchTerm = searchTerm ? searchTerm.toLowerCase() : '';
            let filtered = Object.keys(appState.articles);
            if (appState.currentFilter !== 'All') {
                filtered = filtered.filter(id => appState.articles[id].category === appState.currentFilter);
            }
            if (lowerCaseSearchTerm) {
                filtered = filtered.filter(id => (appState.articles[id].title?.toLowerCase().includes(lowerCaseSearchTerm)) || (appState.articles[id].content?.toLowerCase().includes(lowerCaseSearchTerm)));
            }
            filtered.sort((a, b) => {
                const articleA = appState.articles[a];
                const articleB = appState.articles[b];
                switch (appState.currentSort) {
                    case 'popular': return (articleB.likes || 0) - (articleA.likes || 0);
                    case 'views': return (articleB.views || 0) - (articleA.views || 0);
                    case 'oldest': return new Date(articleA.date) - new Date(articleB.date);
                    default: return new Date(articleB.date) - new Date(articleA.date);
                }
            });
            appState.sortedArticleIds = filtered;
            renderArticleGrid();
        }

        function renderArticleGrid() {
            ui.articleGrid.innerHTML = '';
            if (appState.sortedArticleIds.length === 0) return;
            const likedArticles = JSON.parse(localStorage.getItem('likedArticles') || '[]');
            appState.sortedArticleIds.forEach((id, index) => {
                const article = appState.articles[id];
                if (!article) return;
                const isLiked = likedArticles.includes(id);
                const card = document.createElement('div');
                card.className = 'article-card';
                card.dataset.id = id;
                card.style.animationDelay = `${index * 50}ms`;
                card.innerHTML = `
                    <button class="card-edit-btn"><i class="fas fa-pencil-alt"></i></button>
                    <img src="${article.coverImage || DEFAULT_IMG_URL}" alt="${article.title}" class="card-cover-image" onerror="this.src='${DEFAULT_IMG_URL}'">
                    <div class="card-content">
                        <h3 class="card-title">${article.title}</h3>
                    </div>
                    <div class="card-footer">
                        <span class="card-meta-item"><i class="fas fa-eye"></i> ${article.views || 0}</span>
                        <span class="card-meta-item like-btn ${isLiked ? 'liked' : ''}"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${article.likes || 0}</span>
                        <span class="card-meta-item">${new Date(article.date).toLocaleDateString()}</span>
                    </div>`;
                ui.articleGrid.appendChild(card);
            });
        }
        
        async function renderArticle(id) {
            const article = appState.articles[id];
            if (!article) { switchView('home-view'); return; }

            const viewsRef = ref(db, `blogData/articles/${id}/views`);
            try {
                await runTransaction(viewsRef, (currentViews) => (currentViews || 0) + 1);
                if(appState.articles[id]) appState.articles[id].views = (appState.articles[id].views || 0) + 1;
            } catch (e) { /* fail silently */ }

            const contentHTML = marked.parse(article.content || '');
            const likedArticles = JSON.parse(localStorage.getItem('likedArticles') || '[]');
            const isLiked = likedArticles.includes(id);
            
            ui.articleView.innerHTML = `
                <div class="article-container" data-id="${id}">
                    <img src="${article.coverImage || DEFAULT_IMG_URL}" alt="${article.title}" class="article-header-image" onerror="this.src='${DEFAULT_IMG_URL}'">
                    <h1 class="article-title">${article.title}</h1>
                    <div class="article-meta">
                        <span><i class="fas fa-calendar-alt"></i> ${new Date(article.date).toLocaleDateString()}</span>
                        <span><i class="fas fa-folder"></i> ${article.category}</span>
                        <span><i class="fas fa-eye"></i> ${appState.articles[id].views || 0}</span>
                    </div>
                    <div class="article-content">${contentHTML}</div>
                    <div class="interaction-bar">
                        <button class="btn like-btn ${isLiked ? 'liked' : ''}" id="article-like-btn"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> <span>${isLiked ? '已喜歡' : '喜歡'} (${article.likes || 0})</span></button>
                        <button class="btn" id="share-btn"><i class="fas fa-share-alt"></i> 分享</button>
                    </div>
                    <div class="comments-section">
                        <h2>留言</h2>
                        <div id="comment-list"></div>
                        <form id="comment-form">
                            <input type="text" id="comment-name" placeholder="你的名字 (必填)" required>
                            <textarea id="comment-text" placeholder="分享你的看法..." required></textarea>
                            <button type="submit" class="btn btn-primary">送出留言</button>
                        </form>
                    </div>
                </div>`;
            
            setTimeout(() => ui.articleView.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el)), 0);
            
            renderComments(id, article.comments || {});

            ui.articleView.querySelector('#comment-form').addEventListener('submit', (e) => postComment(e, id));
            ui.articleView.querySelector('#article-like-btn').addEventListener('click', () => toggleLike(id, true));
            ui.articleView.querySelector('#share-btn').addEventListener('click', () => shareArticle(id));
            
            switchView('article-view');
            renderBottomNav(id);
        }

        function renderComments(articleId, comments) {
            const container = document.getElementById('comment-list');
            if(!container) return;
            container.innerHTML = '';
            const sortedKeys = Object.keys(comments).sort((a,b) => b.localeCompare(a));
            if (sortedKeys.length === 0) {
                container.innerHTML = '<p>還沒有人留言，快來搶頭香！</p>'; return;
            }
            sortedKeys.forEach(key => {
                const comment = comments[key];
                const safeName = comment.name?.replace(/</g, "&lt;") || '匿名';
                const safeText = comment.text?.replace(/</g, "&lt;") || '';
                container.innerHTML += `
                    <div class="comment">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(safeName[0])}&background=random&color=fff" alt="avatar" class="comment-avatar">
                        <div class="comment-body"><span class="comment-author">${safeName}</span><p class="comment-text">${safeText}</p></div>
                    </div>`;
            });
        }
        
        async function toggleLike(articleId, fromArticlePage = false) {
            let likedArticles = JSON.parse(localStorage.getItem('likedArticles') || '[]');
            const isLiked = likedArticles.includes(articleId);
            const likesRef = ref(db, `blogData/articles/${articleId}/likes`);

            try {
                await runTransaction(likesRef, (currentLikes) => isLiked ? (currentLikes || 1) - 1 : (currentLikes || 0) + 1);
                
                const newLikes = (appState.articles[articleId].likes || 0) + (isLiked ? -1 : 1);
                appState.articles[articleId].likes = newLikes < 0 ? 0 : newLikes;

                if (isLiked) {
                    likedArticles = likedArticles.filter(id => id !== articleId);
                } else {
                    likedArticles.push(articleId);
                }
                localStorage.setItem('likedArticles', JSON.stringify(likedArticles));
                
                if (fromArticlePage) {
                    renderArticle(articleId);
                } else {
                    const cardLikeIcon = document.querySelector(`.article-card[data-id="${articleId}"] .like-btn i`);
                    const cardLikeSpan = document.querySelector(`.article-card[data-id="${articleId}"] .like-btn`);
                    if(cardLikeIcon) {
                        cardLikeIcon.className = `${isLiked ? 'far' : 'fas'} fa-heart`;
                        cardLikeSpan.classList.toggle('liked', !isLiked);
                        cardLikeSpan.innerHTML = `<i class="${!isLiked ? 'fas' : 'far'} fa-heart"></i> ${appState.articles[articleId].likes}`;
                        cardLikeSpan.classList.add('beating');
                        setTimeout(() => cardLikeSpan.classList.remove('beating'), 300);
                    }
                }
            } catch (error) { console.error("Like transaction failed:", error); }
        }
        
        async function postComment(e, articleId) {
            e.preventDefault();
            const nameInput = document.getElementById('comment-name'), textInput = document.getElementById('comment-text');
            const name = nameInput.value.trim(), text = textInput.value.trim();
            if (!text || !name) return;

            const commentId = `comment_${Date.now()}`;
            try {
                await set(ref(db, `blogData/articles/${articleId}/comments/${commentId}`), { name, text });
                nameInput.value = ''; textInput.value = '';
                appState.articles[articleId].comments = appState.articles[articleId].comments || {};
                appState.articles[articleId].comments[commentId] = { name, text };
                renderComments(articleId, appState.articles[articleId].comments);
            } catch (error) { alert('留言失敗，請確認 Firebase 權限設定。'); }
        }
        
        function shareArticle(id) {
            const url = `${SITE_URL}#${id}`;
            navigator.clipboard?.writeText(url).then(() => alert("已複製文章連結！"), () => prompt("複製失敗，請手動複製:", url));
        }

        function openEditor(id = null) {
            if (!easyMDE) easyMDE = new EasyMDE({ element: ui.editorContent, spellChecker: false });
            if (id) {
                const article = appState.articles[id];
                ui.editorId.value = id;
                ui.editorTitle.value = article.title;
                ui.editorCategory.value = article.category;
                ui.editorCoverImage.value = article.coverImage || '';
                easyMDE.value(article.content || '');
                ui.deleteBtn.style.display = 'flex';
            } else {
                [ui.editorId, ui.editorTitle, ui.editorCategory, ui.editorCoverImage].forEach(el => el.value = '');
                easyMDE.value('');
                ui.deleteBtn.style.display = 'none';
            }
            ui.editorOverlay.classList.add('active');
        }

        async function saveArticle() {
            const id = ui.editorId.value || `post_${Date.now()}`;
            const isNew = !ui.editorId.value;
            const existingData = isNew ? {} : appState.articles[id] || {};
            const articleData = { ...existingData, title: ui.editorTitle.value, category: ui.editorCategory.value, coverImage: ui.editorCoverImage.value, content: easyMDE.value(), date: isNew ? new Date().toISOString() : existingData.date };
            try {
                await set(ref(db, `blogData/articles/${id}`), articleData);
                ui.editorOverlay.classList.remove('active');
                await loadInitialData();
                switchView('home-view');
            } catch(error) { alert('儲存失敗！'); }
        }

        async function deleteArticle() {
            const id = ui.editorId.value;
            if (!id || !confirm('確定要永久刪除這篇文章嗎？')) return;
            try {
                await remove(ref(db, `blogData/articles/${id}`));
                ui.editorOverlay.classList.remove('active');
                await loadInitialData();
                switchView('home-view');
            } catch(error) { alert('刪除失敗！'); }
        }

        const switchView = (viewName) => {
            const isArticle = viewName === 'article-view';
            ui.homeView.classList.toggle('active', !isArticle);
            ui.articleView.classList.toggle('active', isArticle);
            ui.topControls.style.display = isArticle ? 'none' : 'flex';
            ui.articleBottomNav.classList.toggle('active', isArticle);
            ui.body.classList.toggle('bottom-nav-active', isArticle && window.innerWidth <= 768);
            if (!isArticle) window.history.pushState(null, '', SITE_URL);
            window.scrollTo(0,0);
        };
        
        function renderSortOptions(){const o={newest:'最新',oldest:'最舊',popular:'熱門',views:'熱度'};ui.sortDropdown.innerHTML='';Object.entries(o).forEach(([k,v])=>{const i=document.createElement('div');i.className=`dropdown-item ${appState.currentSort===k?'active':''}`;i.textContent=v;i.dataset.sort=k;ui.sortDropdown.appendChild(i)});ui.sortDisplayBtn.innerHTML=`<i class="fas fa-sort"></i> ${o[appState.currentSort]}`;ui.sortDropdown.onclick=e=>{const t=e.target.closest('.dropdown-item');if(t?.dataset.sort){appState.currentSort=t.dataset.sort;filterAndSort(ui.searchInput.value);renderSortOptions();toggleDropdown(ui.sortDropdown)}}}
        function renderCategories(){appState.allCategories= [...new Set(Object.values(appState.articles).map(a=>a.category).filter(Boolean))]; ui.catDropdown.innerHTML='';['All',...appState.allCategories].forEach(c=>{const i=document.createElement('div');i.className=`dropdown-item ${appState.currentFilter===c?'active':''}`;i.textContent=c==='All'?'全部文章':c;i.dataset.cat=c;ui.catDropdown.appendChild(i)});ui.catDisplayBtn.innerHTML=`<i class="fas fa-folder"></i> ${appState.currentFilter==='All'?'全部分類':appState.currentFilter}`;ui.catDropdown.onclick=e=>{const t=e.target.closest('.dropdown-item');if(t?.dataset.cat){appState.currentFilter=t.dataset.cat;filterAndSort(ui.searchInput.value);renderCategories();toggleDropdown(ui.catDropdown)}}}
        function renderBottomNav(id){const i=appState.sortedArticleIds.indexOf(id);const p=i>0?appState.sortedArticleIds[i-1]:null;const n=i<appState.sortedArticleIds.length-1?appState.sortedArticleIds[i+1]:null;ui.articleBottomNav.innerHTML=`<button class="btn prev-btn" data-id="${p}" ${p?'':'disabled'}><i class="fas fa-arrow-left"></i> 上篇</button><button class="btn back-btn"><i class="fas fa-list"></i> 返回列表</button><button class="btn next-btn" data-id="${n}" ${n?'':'disabled'}>下篇 <i class="fas fa-arrow-right"></i></button>`;ui.articleBottomNav.onclick=e=>{const t=e.target.closest('button');if(!t)return;if(t.matches('.back-btn'))switchView('home-view');if(t.matches('.prev-btn:not([disabled])'))window.location.hash=t.dataset.id;if(t.matches('.next-btn:not([disabled])'))window.location.hash=t.dataset.id}}
        const toggleDropdown=d=>{const a=d.classList.contains('active');document.querySelectorAll('.control-dropdown.active').forEach(i=>i.classList.remove('active'));if(!a)d.classList.add('active')}

        function setupEventListeners() {
            ui.siteTitle.addEventListener('click', () => switchView('home-view'));
            ui.newArticleBtn.addEventListener('click', () => openEditor());
            ui.saveBtn.addEventListener('click', saveArticle);
            ui.deleteBtn.addEventListener('click', deleteArticle);
            ui.editorOverlay.addEventListener('click', e => { if (e.target.matches('.overlay, .modal-close-btn')) ui.editorOverlay.classList.remove('active'); });
            ui.articleGrid.addEventListener('click', e => {
                const card = e.target.closest('.article-card'); if (!card) return;
                const id = card.dataset.id;
                if (e.target.closest('.card-edit-btn')) openEditor(id);
                else if (e.target.matches('.like-btn, .like-btn *')) toggleLike(id);
                else window.location.hash = id;
            });
            ui.searchInput.addEventListener('input', (e) => filterAndSort(e.target.value));
            ui.sortDisplayBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleDropdown(ui.sortDropdown); });
            ui.catDisplayBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleDropdown(ui.catDropdown); });
            
            let footerClickCount = 0;
            ui.footer.addEventListener('click', () => {
                footerClickCount = (footerClickCount + 1) % 5;
                if (footerClickCount === 0) {
                     const password = prompt("請輸入管理密碼：");
                    if (password === "980621") {
                        appState.isEditMode = !appState.isEditMode;
                        ui.body.classList.toggle('edit-mode', appState.isEditMode);
                        alert(appState.isEditMode ? "管理模式已啟用" : "已退出管理模式");
                    } else if(password) { alert("密碼錯誤！"); }
                }
            });
            window.addEventListener('hashchange', () => {
                const id = window.location.hash.substring(1);
                if (id && appState.articles[id]) renderArticle(id); else switchView('home-view');
            });
            document.addEventListener('click', () => document.querySelectorAll('.control-dropdown.active').forEach(d=>d.classList.remove('active')));
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                ui.body.classList.add('dark-mode');
                ui.themeToggle.textContent = '🌙';
            }
            ui.themeToggle.addEventListener('click', () => {
                const isDark = ui.body.classList.toggle('dark-mode');
                ui.themeToggle.textContent = isDark ? '🌙' : '☀️';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
            ui.footer.querySelector('p').textContent = `© ${new Date().getFullYear()} Kai's Tech Log. (點此處5次可進入管理模式)`;

            setupEventListeners();
            loadInitialData().then(() => {
                const id = window.location.hash.substring(1);
                if (id) renderArticle(id);
            });
        });
    </script>
</body>
</html>