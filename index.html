<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAI's Tech Log - ‚ú® Â§ßÂäüÂëäÊàêÁâà</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="alternate" type="application/rss+xml" title="Kai's Tech Log RSS Feed" href="/kaistudio/rss.xml">
    
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script>

    <style>
        :root{--bg-color:#f9f9fb;--text-color:#1d1d1f;--primary-color:#0071e3;--accent-color:#ff8c00;--secondary-color:#6e6e73;--border-color:#d2d2d7;--card-bg:#ffffff;--shadow-color:rgba(0,0,0,0.08);--code-bg:#f5f5f7;--danger-color:#ff3b30;--radius-large:20px;--radius-medium:15px;--radius-small:10px;--like-color:#ff3b30}
        body.dark-mode{--bg-color:#000000;--text-color:#f5f5f7;--primary-color:#2997ff;--accent-color:#ff9500;--secondary-color:#8e8e93;--border-color:#424245;--card-bg:#1c1c1e;--shadow-color:rgba(0,0,0,0.3);--code-bg:#2c2c2e}
        *{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}
        body{background-color:var(--bg-color);color:var(--text-color);font-family:-apple-system,BlinkMacSystemFont,"SF Pro TC","ËòãÊñπ-ÁπÅ","PingFang TC","Segoe UI",Helvetica,Arial,sans-serif;line-height:1.7;transition:background-color .4s,color .4s}
        .btn{border:none;padding:9px 18px;border-radius:var(--radius-medium);cursor:pointer;font-weight:600;font-size:.9rem;transition:transform .15s,box-shadow .2s,background-color .2s}.btn:hover{transform:translateY(-2px)}.btn:active{transform:translateY(0) scale(.98)}
        .btn-primary{background:linear-gradient(45deg,var(--accent-color),var(--primary-color));color:white}
        .btn-danger{background-color:var(--danger-color);color:white}
        .site-header{position:sticky;top:0;z-index:100;padding:0 5%;background-color:rgba(var(--bg-color),.8);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid var(--border-color)}
        .header-content{display:flex;justify-content:space-between;align-items:center;min-height:60px;padding:10px 0;max-width:1200px;margin:0 auto;flex-wrap:wrap;gap:10px}
        .site-title{font-size:1.5rem;font-weight:700;cursor:pointer;color:var(--primary-color)}
        .header-controls{display:flex;align-items:center;gap:15px}
        .controls{display:flex;align-items:center;gap:10px}
        .control-group{position:relative}
        .control-btn{background-color:var(--code-bg);border:1px solid var(--border-color);color:var(--secondary-color);padding:8px 16px;border-radius:var(--radius-medium);cursor:pointer;font-weight:600;font-size:.9rem;display:flex;align-items:center;gap:6px}
        .control-dropdown{display:none;position:absolute;top:110%;right:0;min-width:180px;background-color:var(--card-bg);border:1px solid var(--border-color);border-radius:var(--radius-large);z-index:110;padding:8px;box-shadow:0 8px 30px var(--shadow-color);animation:popIn .2s ease-out}@keyframes popIn{from{opacity:0;transform:scale(.95) translateY(-10px)}to{opacity:1;transform:scale(1) translateY(0)}}
        .control-dropdown.active{display:block}
        .dropdown-item{display:block;width:100%;text-align:left;padding:10px 15px;border:none;background:none;color:var(--text-color);cursor:pointer;border-radius:var(--radius-small)}.dropdown-item:hover,.dropdown-item.active{background-color:var(--primary-color);color:white}
        .search-input{width:180px;padding:8px 15px;border-radius:var(--radius-medium);border:1px solid var(--border-color);background-color:var(--code-bg);color:var(--text-color)}
        .theme-toggle{cursor:pointer;font-size:1.5rem;display:grid;place-items:center}
        #new-article-btn{display:none}
        body.edit-mode #new-article-btn{display:inline-block}
        main{padding:40px 5%;min-height:calc(100vh - 140px);max-width:1280px;margin:0 auto}
        .view{display:none}.view.active{display:block;animation:fadeIn .5s ease}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .article-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:30px}
        .article-card{background-color:var(--card-bg);border-radius:var(--radius-large);overflow:hidden;box-shadow:0 4px 25px var(--shadow-color);transition:transform .3s,box-shadow .3s;position:relative;display:flex;flex-direction:column}
        .article-card:hover{transform:translateY(-8px);box-shadow:0 12px 40px var(--shadow-color)}
        .card-cover-image{width:100%;aspect-ratio:16/10;object-fit:cover;background-color:var(--border-color);cursor:pointer}
        .card-content{padding:20px;cursor:pointer;flex-grow:1}
        .card-title{font-size:1.25rem;font-weight:600;margin-bottom:12px}
        .card-footer{padding:0 20px 15px;display:flex;justify-content:space-between;align-items:center;color:var(--secondary-color);font-size:.9rem;flex-wrap:wrap;gap:5px 15px}
        .card-meta-item{display:flex;align-items:center;gap:6px}
        .like-btn{cursor:pointer}.like-btn.liked{color:var(--like-color)}
        .card-edit-btn{position:absolute;top:15px;right:15px;background-color:rgba(var(--accent-color),.8);color:white;border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;z-index:5;backdrop-filter:blur(5px);display:none;place-items:center}
        body.edit-mode .card-edit-btn{display:grid}
        .article-container{max-width:800px;margin:0 auto;padding-bottom:50px}
        .article-header-image{width:100%;aspect-ratio:21/9;object-fit:cover;border-radius:var(--radius-large);margin-bottom:30px;background-color:var(--border-color)}
        .article-title{font-size:2.5rem;font-weight:700;line-height:1.3;margin-bottom:15px}
        .article-meta{color:var(--secondary-color);margin-bottom:30px;font-size:.95rem;display:flex;flex-wrap:wrap;gap:8px 20px;align-items:center}
        .article-content{font-size:1.1rem;line-height:1.8}
        .interaction-bar{margin:40px 0;display:flex;align-items:center;gap:20px;border-top:1px solid var(--border-color);border-bottom:1px solid var(--border-color);padding:15px 0}
        .comments-section{margin-top:50px}
        #comment-form input,#comment-form textarea{width:100%;padding:12px;border-radius:var(--radius-medium);border:1px solid var(--border-color);background-color:var(--code-bg);color:var(--text-color);font-size:1rem;margin-bottom:10px}
        #comment-list .comment{display:flex;gap:15px;padding:15px 0;border-bottom:1px solid var(--border-color)}
        .comment-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;background-color:var(--border-color)}
        .comment-body{flex-grow:1}
        .comment-author{font-weight:600}
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000;display:none;align-items:center;justify-content:center;animation:fadeIn .3s}
        .overlay.active{display:flex}
        .modal{width:95%;max-width:900px;max-height:90vh;border-radius:var(--radius-large);display:flex;flex-direction:column;background-color:var(--card-bg);box-shadow:0 10px 40px rgba(0,0,0,.2)}
        .modal-header{padding:20px 25px;border-bottom:1px solid var(--border-color);font-size:1.3rem;font-weight:600;display:flex;justify-content:space-between;align-items:center}
        .modal-close-btn{background:0 0;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-color)}
        .modal-body{padding:25px;overflow-y:auto;flex-grow:1}
        .modal-footer{padding:15px 25px;border-top:1px solid var(--border-color);display:flex;justify-content:space-between;gap:10px}
        #editor-modal .modal-body{padding:10px}#editor-modal input{width:100%;padding:10px;border-radius:var(--radius-medium);border:1px solid var(--border-color);background-color:var(--bg-color);color:var(--text-color);font-size:1rem}
        #editor-modal input,.EasyMDEContainer{margin-bottom:15px}
        .EasyMDEContainer{border:1px solid var(--border-color);border-radius:var(--radius-medium)}
        .loader{text-align:center;padding:50px;}
        .site-footer{padding:40px 5%;text-align:center;color:var(--secondary-color);border-top:1px solid var(--border-color);margin-top:30px;cursor:pointer;transition:margin-bottom .3s}
        .article-bottom-nav{position:fixed;bottom:0;left:0;width:100%;background-color:rgba(var(--card-bg),.8);backdrop-filter:blur(10px);border-top:1px solid var(--border-color);display:none;justify-content:space-between;align-items:center;padding:15px 5%;z-index:200;animation:fadeIn .3s}
        body.bottom-nav-active .site-footer { margin-bottom: 80px; } /* Push footer up */
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-content">
            <div id="site-title" class="site-title">‚ú® Kai's Tech Log</div>
            <div class="header-controls">
                <div class="search-box"><input type="search" id="search-input" class="search-input" placeholder="ÊêúÂ∞ã..."></div>
                <div id="top-controls" class="controls">
                    <button id="new-article-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Êñ∞Â¢û</button>
                    <div class="control-group">
                        <button id="sort-display-btn" class="control-btn">ÊéíÂ∫è ‚ñº</button>
                        <div id="sort-dropdown" class="control-dropdown"></div>
                    </div>
                    <div class="control-group">
                        <button id="category-display-btn" class="control-btn">ÂàÜÈ°û ‚ñº</button>
                        <div id="category-dropdown" class="control-dropdown"></div>
                    </div>
                </div>
                <div class="theme-toggle" id="theme-toggle">‚òÄÔ∏è</div>
            </div>
        </div>
    </header>

    <main>
        <div id="home-view" class="view active">
            <div id="loader" class="loader"><p>Ê≠£Âú®ÂæûÈõ≤Á´ØËºâÂÖ•Ë≥áÊñô...</p></div>
            <div class="article-grid" id="article-grid"></div>
        </div>
        <div id="article-view" class="view"></div>
    </main>
    
    <nav id="article-bottom-nav" class="article-bottom-nav"></nav>

    <!-- Editor Modal -->
    <div id="editor-overlay" class="overlay">
        <div id="editor-modal" class="modal">
            <div class="modal-header">
                <span id="editor-modal-title">Á∑®ËºØÊñáÁ´†</span>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editor-id">
                <input type="text" id="editor-title" placeholder="ÊñáÁ´†Ê®ôÈ°å">
                <input type="text" id="editor-category" placeholder="ÂàÜÈ°û">
                <input type="text" id="editor-cover-image" placeholder="Â∞ÅÈù¢ÂúñÁâá URL">
                <textarea id="editor-content"></textarea>
            </div>
            <div class="modal-footer">
                <button id="delete-btn" class="btn btn-danger">Âà™Èô§</button>
                <button id="save-btn" class="btn btn-primary">ÂÑ≤Â≠òÁôºÂ∏É</button>
            </div>
        </div>
    </div>
    
    <footer id="site-footer" class="site-footer">
        <p>¬© 2024 Kai's Tech Log. (ÈÄ£Á∫åÈªûÊìäÊ≠§ËôïÈÄ≤ÂÖ•ÁÆ°ÁêÜÊ®°Âºè)</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, get, remove, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAKiC62bh50NXLMWwbfNHekmVCBtTtam6Y",
          authDomain: "blog-63ad2.firebaseapp.com",
          databaseURL: "https://blog-63ad2-default-rtdb.firebaseio.com",
          projectId: "blog-63ad2",
          storageBucket: "blog-63ad2.appspot.com",
          messagingSenderId: "265914768921",
          appId: "1:265914768921:web:e4c752780e604d0be69488"
        };
        
        const SITE_URL = "https://kaihchs118.github.io/kaistudio/";

        let appState = { articles: {}, allCategories: [], isEditMode: false, currentFilter: 'All', currentSort: 'newest', sortedArticleIds: [] };
        initializeApp(firebaseConfig);
        const db = getDatabase();
        const articlesRef = ref(db, 'blogData/articles');
        const categoriesRef = ref(db, 'blogData/categories');

        const ui = {
            body: document.body, loader: document.getElementById('loader'), articleGrid: document.getElementById('article-grid'),
            homeView: document.getElementById('home-view'), articleView: document.getElementById('article-view'),
            topControls: document.getElementById('top-controls'),
            sortDisplayBtn: document.getElementById('sort-display-btn'), sortDropdown: document.getElementById('sort-dropdown'),
            catDisplayBtn: document.getElementById('category-display-btn'), catDropdown: document.getElementById('category-dropdown'),
            siteTitle: document.getElementById('site-title'), searchInput: document.getElementById('search-input'), themeToggle: document.getElementById('theme-toggle'),
            newArticleBtn: document.getElementById('new-article-btn'),
            editorOverlay: document.getElementById('editor-overlay'), editorId: document.getElementById('editor-id'), editorTitle: document.getElementById('editor-title'),
            editorCategory: document.getElementById('editor-category'), editorCoverImage: document.getElementById('editor-cover-image'),
            saveBtn: document.getElementById('save-btn'), deleteBtn: document.getElementById('delete-btn'),
            footer: document.getElementById('site-footer'), 
            articleBottomNav: document.getElementById('article-bottom-nav')
        };
        let easyMDE;
        const DEFAULT_IMG_URL = 'https://i.imgur.com/g22yT3s.png';

        async function loadInitialData() {
            ui.loader.style.display = 'block';
            try {
                const [articlesSnapshot, categoriesSnapshot] = await Promise.all([get(articlesRef), get(categoriesRef)]);
                appState.articles = articlesSnapshot.exists() ? articlesSnapshot.val() : {};
                appState.allCategories = categoriesSnapshot.exists() ? categoriesSnapshot.val() : [];
                filterAndSort();
                renderCategories();
                renderSortOptions();
            } catch (error) {
                console.error("Firebase data loading failed:", error);
                ui.loader.innerHTML = `<p style="color:red;"><b>Ë≥áÊñôËºâÂÖ•Â§±ÊïóÔºÅ</b><br>Ë´ãÁ¢∫Ë™ç Firebase Ë≥áÊñôÂ∫´Ë¶èÂâáÂ∑≤Ë®≠ÂÆöÊ≠£Á¢∫„ÄÇ<br>(${error.message})</p>`;
            } finally {
                ui.loader.style.display = 'none';
            }
        }

        function filterAndSort(searchTerm = '') {
            const lowerCaseSearchTerm = searchTerm ? searchTerm.toLowerCase() : '';
            let filtered = Object.keys(appState.articles);
            if (appState.currentFilter !== 'All') {
                filtered = filtered.filter(id => appState.articles[id].category === appState.currentFilter);
            }
            if (lowerCaseSearchTerm) {
                filtered = filtered.filter(id => {
                    const article = appState.articles[id];
                    return (article.title?.toLowerCase().includes(lowerCaseSearchTerm)) ||
                           (article.content?.toLowerCase().includes(lowerCaseSearchTerm));
                });
            }
            filtered.sort((a, b) => {
                const articleA = appState.articles[a];
                const articleB = appState.articles[b];
                switch (appState.currentSort) {
                    case 'popular': return (articleB.likes || 0) - (articleA.likes || 0);
                    case 'views': return (articleB.views || 0) - (articleA.views || 0);
                    case 'oldest': return new Date(articleA.date) - new Date(articleB.date);
                    default: return new Date(articleB.date) - new Date(articleA.date);
                }
            });
            appState.sortedArticleIds = filtered;
            renderArticleGrid();
        }

        function renderArticleGrid() {
            ui.articleGrid.innerHTML = '';
            if (appState.sortedArticleIds.length === 0) return;
            const likedArticles = JSON.parse(localStorage.getItem('likedArticles') || '[]');
            appState.sortedArticleIds.forEach(id => {
                const article = appState.articles[id];
                if (!article) return;
                const isLiked = likedArticles.includes(id);
                const cardHTML = `
                    <div class="article-card" data-id="${id}">
                        <button class="card-edit-btn"><i class="fas fa-pencil-alt"></i></button>
                        <img src="${article.coverImage || DEFAULT_IMG_URL}" alt="${article.title}" class="card-cover-image" onerror="this.src='${DEFAULT_IMG_URL}'">
                        <div class="card-content">
                            <h3 class="card-title">${article.title}</h3>
                        </div>
                        <div class="card-footer">
                            <span class="card-meta-item"><i class="fas fa-eye"></i> ${article.views || 0}</span>
                            <span class="card-meta-item like-btn ${isLiked ? 'liked' : ''}"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${article.likes || 0}</span>
                            <span class="card-meta-item">${new Date(article.date).toLocaleDateString()}</span>
                        </div>
                    </div>`;
                ui.articleGrid.insertAdjacentHTML('beforeend', cardHTML);
            });
        }

        function renderArticle(id) {
            const article = appState.articles[id];
            if (!article) { switchView('home-view'); return; }

            const viewsRef = ref(db, `blogData/articles/${id}/views`);
            runTransaction(viewsRef, (currentViews) => (currentViews || 0) + 1).then(() => {
                if(appState.articles[id]) appState.articles[id].views = (appState.articles[id].views || 0) + 1;
            });

            const contentHTML = marked.parse(article.content || '');
            const likedArticles = JSON.parse(localStorage.getItem('likedArticles') || '[]');
            const isLiked = likedArticles.includes(id);
            
            ui.articleView.innerHTML = `
                <div class="article-container" data-id="${id}">
                    <img src="${article.coverImage || DEFAULT_IMG_URL}" alt="${article.title}" class="article-header-image" onerror="this.src='${DEFAULT_IMG_URL}'">
                    <h1 class="article-title">${article.title}</h1>
                    <div class="article-meta">
                        <span><i class="fas fa-calendar-alt"></i> ${new Date(article.date).toLocaleDateString()}</span>
                        <span><i class="fas fa-folder"></i> ${article.category}</span>
                        <span><i class="fas fa-eye"></i> ${article.views || 0} Ê¨°ËßÄÁúã</span>
                    </div>
                    <div class="article-content">${contentHTML}</div>
                    <div class="interaction-bar">
                        <button class="btn like-btn ${isLiked ? 'liked' : ''}" id="article-like-btn"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> <span>${isLiked ? 'Â∑≤ÂñúÊ≠°' : 'ÂñúÊ≠°'} (${article.likes || 0})</span></button>
                        <button class="btn" id="share-btn"><i class="fas fa-share-alt"></i> ÂàÜ‰∫´</button>
                    </div>
                    <div class="comments-section">
                        <h2>ÁïôË®Ä</h2>
                        <div id="comment-list"></div>
                        <form id="comment-form">
                            <input type="text" id="comment-name" placeholder="‰Ω†ÁöÑÂêçÂ≠ó (ÂøÖÂ°´)" required>
                            <textarea id="comment-text" placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÁúãÊ≥ï..." required></textarea>
                            <button type="submit" class="btn btn-primary">ÈÄÅÂá∫ÁïôË®Ä</button>
                        </form>
                    </div>
                </div>`;
            
            setTimeout(() => ui.articleView.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el)), 0);
            
            renderComments(id, article.comments || {});

            ui.articleView.querySelector('#comment-form').addEventListener('submit', (e) => postComment(e, id));
            ui.articleView.querySelector('#article-like-btn').addEventListener('click', () => toggleLike(id));
            ui.articleView.querySelector('#share-btn').addEventListener('click', () => shareArticle(id));
            
            switchView('article-view');
            renderBottomNav(id);
        }

        function renderComments(articleId, comments) {
            const container = document.getElementById('comment-list');
            if(!container) return;
            container.innerHTML = '';
            const sortedKeys = Object.keys(comments).sort((a,b) => b.localeCompare(a));
            if (sortedKeys.length === 0) {
                container.innerHTML = '<p>ÈÇÑÊ≤íÊúâ‰∫∫ÁïôË®ÄÔºåÂø´‰æÜÊê∂È†≠È¶ôÔºÅ</p>'; return;
            }
            sortedKeys.forEach(key => {
                const comment = comments[key];
                container.innerHTML += `
                    <div class="comment">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(comment.name || 'V')}&background=random&color=fff" alt="avatar" class="comment-avatar">
                        <div class="comment-body">
                            <span class="comment-author">${comment.name.replace(/</g, "&lt;")}</span>
                            <p>${comment.text.replace(/</g, "&lt;")}</p>
                        </div>
                    </div>`;
            });
        }
        
        async function toggleLike(articleId) {
            let likedArticles = JSON.parse(localStorage.getItem('likedArticles') || '[]');
            const likesRef = ref(db, `blogData/articles/${articleId}/likes`);
            let isLiked = likedArticles.includes(articleId);

            try {
                await runTransaction(likesRef, (currentLikes) => isLiked ? (currentLikes || 1) - 1 : (currentLikes || 0) + 1);

                if (isLiked) {
                    likedArticles = likedArticles.filter(id => id !== articleId);
                } else {
                    likedArticles.push(articleId);
                }
                localStorage.setItem('likedArticles', JSON.stringify(likedArticles));
                
                // Manually update local state to avoid full reload
                const newLikes = (appState.articles[articleId].likes || 0) + (isLiked ? -1 : 1);
                appState.articles[articleId].likes = newLikes < 0 ? 0 : newLikes;

                if (ui.homeView.classList.contains('active')) {
                    renderArticleGrid();
                } else {
                    renderArticle(articleId);
                }
            } catch (error) {
                console.error("Like transaction failed:", error);
            }
        }
        
        async function postComment(e, articleId) {
            e.preventDefault();
            const nameInput = document.getElementById('comment-name');
            const textInput = document.getElementById('comment-text');
            const name = nameInput.value.trim();
            const text = textInput.value.trim();
            if (!text || !name) return;

            const commentId = `comment_${Date.now()}`;
            const commentRef = ref(db, `blogData/articles/${articleId}/comments/${commentId}`);
            try {
                await set(commentRef, { name, text });
                nameInput.value = ''; textInput.value = '';
                appState.articles[articleId].comments = appState.articles[articleId].comments || {};
                appState.articles[articleId].comments[commentId] = { name, text };
                renderComments(articleId, appState.articles[articleId].comments);
            } catch (error) {
                alert('ÁïôË®ÄÂ§±ÊïóÔºåË´ãÁ¢∫Ë™ç Firebase Ê¨äÈôêË®≠ÂÆö„ÄÇ');
            }
        }
        
        function shareArticle(id) {
            const url = `${SITE_URL}#${id}`;
            navigator.clipboard.writeText(url).then(() => {
                alert("Â∑≤Ë§áË£ΩÊñáÁ´†ÈÄ£ÁµêÔºÅ");
            }, () => {
                prompt("Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£Ω:", url);
            });
        }

        function openEditor(id = null) {
            if (!easyMDE) easyMDE = new EasyMDE({ element: document.getElementById('editor-content') });
            if (id) {
                const article = appState.articles[id];
                ui.editorId.value = id;
                ui.editorTitle.value = article.title;
                ui.editorCategory.value = article.category;
                ui.editorCoverImage.value = article.coverImage || '';
                easyMDE.value(article.content || '');
                ui.deleteBtn.style.display = 'block';
            } else {
                [ui.editorId, ui.editorTitle, ui.editorCategory, ui.editorCoverImage].forEach(el => el.value = '');
                easyMDE.value('');
                ui.deleteBtn.style.display = 'none';
            }
            ui.editorOverlay.classList.add('active');
        }

        async function saveArticle() {
            const id = ui.editorId.value || `post_${Date.now()}`;
            const isNew = !ui.editorId.value;
            // [FIX] Preserve existing data when saving
            const existingData = isNew ? {} : appState.articles[id] || {};
            const articleData = {
                ...existingData, // Start with old data
                title: ui.editorTitle.value,
                date: isNew ? new Date().toISOString() : existingData.date, // Only set date on creation
                category: ui.editorCategory.value,
                coverImage: ui.editorCoverImage.value,
                content: easyMDE.value(),
            };
            const articleRef = ref(db, `blogData/articles/${id}`);
            try {
                await set(articleRef, articleData);
                ui.editorOverlay.classList.remove('active');
                await loadInitialData();
                switchView('home-view');
            } catch(error) {
                 alert('ÂÑ≤Â≠òÂ§±ÊïóÔºÅ');
            }
        }

        async function deleteArticle() {
            const id = ui.editorId.value;
            if (!id || !confirm('Á¢∫ÂÆöË¶ÅÊ∞∏‰πÖÂà™Èô§ÈÄôÁØáÊñáÁ´†ÂóéÔºü')) return;
            try {
                await remove(ref(db, `blogData/articles/${id}`));
                ui.editorOverlay.classList.remove('active');
                await loadInitialData();
                switchView('home-view');
            } catch(error) {
                alert('Âà™Èô§Â§±ÊïóÔºÅ');
            }
        }
        
        window.generateRSS = function() {
            const articles = Object.entries(appState.articles).sort(([,a],[,b]) => new Date(b.date) - new Date(a.date));
            let rssItems = '';
            articles.slice(0, 20).forEach(([id, article]) => {
                const url = `${SITE_URL}#${id}`;
                const description = article.content ? marked.parse(article.content).replace(/<[^>]*>/g, '').substring(0, 200) : '';
                rssItems += `
            <item>
                <title><![CDATA[${article.title}]]></title>
                <link>${url}</link>
                <guid isPermaLink="true">${url}</guid>
                <pubDate>${new Date(article.date).toUTCString()}</pubDate>
                <description><![CDATA[${description}...]]></description>
            </item>`;
            });
            const rssFeed = `<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
    <title>Kai's Tech Log</title>
    <link>${SITE_URL}</link>
    <description>Kai ÁöÑÊäÄË°ìËàáÁîüÊ¥ªÂàÜ‰∫´</description>
    <language>zh-Hant</language>
    <atom:link href="${SITE_URL}rss.xml" rel="self" type="application/rss+xml" />
    ${rssItems}
</channel>
</rss>`;
            console.log(rssFeed);
            alert("RSS XML Â∑≤Ëº∏Âá∫Âà∞ÁÄèË¶ΩÂô®‰∏ªÊéßÂè∞ (F12)ÔºÅË´ãË§áË£Ω‰∏¶ÊâãÂãïÂÑ≤Â≠òÁÇ∫ rss.xml Ê™îÊ°à„ÄÇ");
        }

        const switchView = (viewName) => {
            const isArticle = viewName === 'article-view';
            ui.homeView.classList.toggle('active', !isArticle);
            ui.articleView.classList.toggle('active', isArticle);
            ui.topControls.style.display = isArticle ? 'none' : 'flex';
            ui.body.classList.toggle('bottom-nav-active', isArticle);
            if (!isArticle) window.history.pushState(null, '', SITE_URL);
            window.scrollTo(0,0);
        };
        
        function renderSortOptions(){const o={newest:'ÊúÄÊñ∞',oldest:'ÊúÄËàä',popular:'ÁÜ±ÈñÄ',views:'ÁÜ±Â∫¶'};ui.sortDropdown.innerHTML='';Object.entries(o).forEach(([k,v])=>{const i=document.createElement('div');i.className=`dropdown-item ${appState.currentSort===k?'active':''}`;i.textContent=v;i.dataset.sort=k;ui.sortDropdown.appendChild(i)});ui.sortDisplayBtn.innerHTML=`ÊéíÂ∫è: ${o[appState.currentSort]}`;ui.sortDropdown.onclick=e=>{if(e.target.dataset.sort){appState.currentSort=e.target.dataset.sort;filterAndSort(ui.searchInput.value);renderSortOptions();toggleDropdown(ui.sortDropdown)}}}
        function renderCategories(){ui.catDropdown.innerHTML='';['All',...new Set(Object.values(appState.articles).map(a=>a.category))].forEach(c=>{const i=document.createElement('div');i.className=`dropdown-item ${appState.currentFilter===c?'active':''}`;i.textContent=c==='All'?'ÂÖ®ÈÉ®ÊñáÁ´†':c;i.dataset.cat=c;ui.catDropdown.appendChild(i)});ui.catDisplayBtn.textContent=`ÂàÜÈ°û: ${appState.currentFilter==='All'?'ÂÖ®ÈÉ®':appState.currentFilter}`;ui.catDropdown.onclick=e=>{if(e.target.dataset.cat){appState.currentFilter=e.target.dataset.cat;filterAndSort(ui.searchInput.value);renderCategories();toggleDropdown(ui.catDropdown)}}}
        function renderBottomNav(id){const i=appState.sortedArticleIds.indexOf(id);const p=i>0?appState.sortedArticleIds[i-1]:null;const n=i<appState.sortedArticleIds.length-1?appState.sortedArticleIds[i+1]:null;ui.articleBottomNav.innerHTML=`<button class="btn prev-btn" data-id="${p}" ${p?'':'disabled'}>‚Üê ‰∏äÁØá</button><button class="btn back-btn">ËøîÂõûÂàóË°®</button><button class="btn next-btn" data-id="${n}" ${n?'':'disabled'}>‰∏ãÁØá ‚Üí</button>`;ui.articleBottomNav.style.display='flex';ui.articleBottomNav.onclick=e=>{const t=e.target;if(t.matches('.back-btn'))switchView('home-view');if(t.matches('.prev-btn:not([disabled])'))window.location.hash=t.dataset.id;if(t.matches('.next-btn:not([disabled])'))window.location.hash=t.dataset.id}}
        const toggleDropdown=d=>{const a=d.classList.contains('active');document.querySelectorAll('.control-dropdown.active').forEach(i=>i.classList.remove('active'));if(!a)d.classList.add('active')}

        function setupEventListeners() {
            ui.siteTitle.addEventListener('click', () => switchView('home-view'));
            ui.newArticleBtn.addEventListener('click', () => openEditor());
            ui.saveBtn.addEventListener('click', saveArticle);
            ui.deleteBtn.addEventListener('click', deleteArticle);
            ui.editorOverlay.addEventListener('click', e => { if (e.target.matches('.overlay, .modal-close-btn')) ui.editorOverlay.classList.remove('active'); });
            ui.articleGrid.addEventListener('click', e => {
                const card = e.target.closest('.article-card');
                if (!card) return;
                const id = card.dataset.id;
                if (e.target.closest('.card-edit-btn')) { openEditor(id); }
                else if (e.target.matches('.like-btn, .like-btn *')) { toggleLike(id); }
                else { window.location.hash = id; }
            });
            ui.searchInput.addEventListener('input', (e) => filterAndSort(e.target.value));
            ui.sortDisplayBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleDropdown(ui.sortDropdown); });
            ui.catDisplayBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleDropdown(ui.catDropdown); });

            let footerClickCount = 0;
            ui.footer.addEventListener('click', () => {
                footerClickCount = (footerClickCount + 1) % 5;
                if (footerClickCount === 0) {
                     const password = prompt("Ë´ãËº∏ÂÖ•ÁÆ°ÁêÜÂØÜÁ¢ºÔºö");
                    if (password === "980621") {
                        appState.isEditMode = !appState.isEditMode;
                        ui.body.classList.toggle('edit-mode', appState.isEditMode);
                        alert(appState.isEditMode ? "ÁÆ°ÁêÜÊ®°ÂºèÂ∑≤ÂïüÁî®" : "Â∑≤ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè");
                    } else if(password) {
                        alert("ÂØÜÁ¢ºÈåØË™§ÔºÅ");
                    }
                }
            });
            window.addEventListener('hashchange', () => {
                const id = window.location.hash.substring(1);
                if (id && appState.articles[id]) renderArticle(id); else switchView('home-view');
            });
            document.addEventListener('click', () => document.querySelectorAll('.control-dropdown.active').forEach(d=>d.classList.remove('active')));
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                ui.body.classList.add('dark-mode');
                ui.themeToggle.textContent = 'üåô';
            }
            ui.themeToggle.addEventListener('click', () => {
                const isDark = ui.body.classList.toggle('dark-mode');
                ui.themeToggle.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
            ui.footer.querySelector('p').textContent = `¬© ${new Date().getFullYear()} Kai's Tech Log. (ÈÄ£Á∫åÈªûÊìäÊ≠§ËôïÈÄ≤ÂÖ•ÁÆ°ÁêÜÊ®°Âºè)`;

            setupEventListeners();
            loadInitialData().then(() => {
                const id = window.location.hash.substring(1);
                if (id) renderArticle(id);
            });
        });
    </script>
</body>
</html>