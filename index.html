<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAI's Tech Log - üöÄ Pro Version</title>

    <!-- Libs: Toast UI Editor for a modern writing experience -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <style>
        :root {
            --primary-color: #007aff; --accent-color: #ff9500; --danger-color: #ff3b30; --success-color: #34c759;
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #1d1d1f; --secondary-text: #6c757d;
            --border-color: #dee2e6; --shadow: 0 4px 15px rgba(0, 0, 0, 0.07); --radius: 12px;
        }
        body.dark-mode {
            --bg-color: #000000; --card-bg: #1c1c1e; --text-color: #f5f5f7; --secondary-text: #8d8d93;
            --border-color: #3a3a3c; --shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        main { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
        /* --- Header --- */
        .site-header { position: sticky; top: 0; z-index: 100; background-color: rgba(var(--bg-color), 0.8); backdrop-filter: blur(10px); padding: 10px 15px; border-bottom: 1px solid var(--border-color); }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; gap: 15px; }
        .site-title { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); cursor: pointer; }
        .controls { display: flex; align-items: center; gap: 10px; }
        .btn { border: none; padding: 8px 16px; border-radius: var(--radius); cursor: pointer; font-weight: 600; background: var(--primary-color); color: #fff; transition: all 0.2s; }
        .search-input { padding: 8px 12px; border-radius: var(--radius); border: 1px solid var(--border-color); background-color: var(--bg-color); }
        /* --- Article Grid --- */
        .article-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .article-card { background: var(--card-bg); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); cursor: pointer; transition: all 0.2s ease-out; }
        .article-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .card-cover { width: 100%; height: 200px; object-fit: cover; background-color: var(--border-color);}
        .card-content { padding: 15px; }
        .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; }
        .tag { color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        /* --- Article View --- */
        .article-container { max-width: 720px; margin: 0 auto; background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); }
        .article-header-image { width: 100%; max-height: 450px; object-fit: cover; border-radius: var(--radius); margin-bottom: 25px; }
        .article-title { font-size: 2.4rem; line-height: 1.2; margin-bottom: 15px; }
        .article-meta-info { display: flex; align-items: center; flex-wrap: wrap; gap: 5px 15px; color: var(--secondary-text); font-size: 0.9rem; margin-bottom: 25px; }
        .article-meta-info div { display: flex; align-items: center; gap: 5px; }
        .article-content { font-size: 1.1rem; line-height: 1.8; }
        .article-content img { max-width: 100%; border-radius: var(--radius); }
        #scroll-progress-bar { position: fixed; top: 0; left: 0; height: 4px; background: var(--primary-color); width: 0%; z-index: 200; transition: width 0.1s; }
        /* --- Article Bottom Nav --- */
        .article-bottom-nav { position: sticky; bottom: 0; background: rgba(var(--card-bg), 0.85); backdrop-filter: blur(10px); display: flex; justify-content: space-between; padding: 10px 15px; border-top: 1px solid var(--border-color); margin-top:30px; }
        /* --- Comments (YouTube Style) --- */
        .comment-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .comment-header { font-size: 1.2rem; margin-bottom: 20px; }
        .comment-form-container { display: flex; gap: 10px; align-items: flex-start; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white; display: grid; place-items: center; font-weight: 600; flex-shrink: 0; }
        .comment-input-area { width: 100%; }
        .comment-input { width: 100%; border: none; background: transparent; border-bottom: 2px solid var(--border-color); padding: 5px 0; margin-bottom: 10px; font-size: 1rem; }
        .comment { display: flex; gap: 15px; margin-top: 20px; }
        .comment-content .author { font-weight: 600; }
        .comment-content .timestamp { font-size: 0.8rem; color: var(--secondary-text); margin-left: 8px; }
        /* --- Management Modal --- */
        #mgmt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .mgmt-modal { width: 95%; max-width: 600px; height: 80vh; background: var(--card-bg); border-radius: var(--radius); display: flex; flex-direction: column; }
        .mgmt-header { padding: 15px; display: flex; border-bottom: 1px solid var(--border-color); }
        .mgmt-header .tab { padding: 8px 15px; cursor: pointer; border-bottom: 3px solid transparent; }
        .mgmt-header .tab.active { border-bottom-color: var(--primary-color); font-weight: 600; }
        .mgmt-body { flex-grow: 1; padding: 15px; overflow-y: auto; }
        .mgmt-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .mgmt-item .color-dot { width: 20px; height: 20px; border-radius: 50%; }
        /* Like button SVG */
        .like-icon { cursor: pointer; width: 24px; height: 24px; }
        .like-icon path { transition: all 0.2s; }
        .like-icon.unliked path { fill: none; stroke: var(--secondary-text); stroke-width: 2; }
        .like-icon.liked path { fill: var(--danger-color); stroke: var(--danger-color); stroke-width: 2; }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: stretch; gap: 8px; }
            .article-title { font-size: 1.8rem; }
            .article-container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="scroll-progress-bar"></div>
    <header class="site-header">
        <div class="header-content">
            <h1 id="site-title" class="site-title">üöÄ Kai's Tech Log</h1>
            <div class="controls">
                <input type="search" id="search-input" class="search-input" placeholder="ÊêúÂ∞ãÊñáÁ´†...">
                <button id="theme-toggle" class="btn">üåô</button>
                <button id="manage-btn" class="btn" style="display:none;">‚öôÔ∏è ÁÆ°ÁêÜ</button>
                <button id="new-article-btn" class="btn" style="display:none;">+ Êñ∞Â¢û</button>
            </div>
        </div>
    </header>
    <main>
        <div id="home-view" class="view active">
            <div id="article-grid"></div>
        </div>
        <div id="article-view" class="view"></div>
    </main>

    <!-- Editor Modal -->
    <div id="editor-overlay" style="display:none;"> <!-- Hidden by default --> </div>
    <!-- Site Management Modal (for Tags and Categories) -->
    <div id="mgmt-overlay">
        <div class="mgmt-modal">
            <div class="mgmt-header">
                <div class="tab active" data-tab="categories">ÂàÜÈ°ûÁÆ°ÁêÜ</div>
                <div class="tab" data-tab="tags">Ê®ôÁ±§ÁÆ°ÁêÜ</div>
                <button id="close-mgmt-btn" style="margin-left:auto;">‚úñ</button>
            </div>
            <div id="mgmt-body-categories" class="mgmt-body"></div>
            <div id="mgmt-body-tags" class="mgmt-body" style="display:none;"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, get, remove, update, increment } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        // --- Firebase Config ---
        const firebaseConfig = { /* Your Config Here */ };

        // --- Init ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let appState = { articles: {}, categories: [], tags: [], isEditMode: false };
        let editor;

        // --- UI Elements ---
        const ui = Object.fromEntries(['scroll-progress-bar', 'site-title', 'search-input', 'theme-toggle', 'manage-btn', 'new-article-btn', 'home-view', 'article-grid', 'article-view', 'editor-overlay', 'mgmt-overlay', 'close-mgmt-btn'].map(id => [id.replace(/-(\w)/g, (m, g) => g.toUpperCase()), document.getElementById(id)]));

        // --- Helper Functions ---
        const showError = msg => { alert(msg); console.error(msg); };
        const calculateReadingTime = text => `${Math.ceil((text || "").split(/\s+/).length / 200)} ÂàÜÈêò`;

        // --- Core Application ---
        async function loadData() {
            try {
                const [articlesSnap, catsSnap, tagsSnap] = await Promise.all([
                    get(ref(db, 'articles')), get(ref(db, 'categories')), get(ref(db, 'tags'))
                ]);
                appState.articles = articlesSnap.val() || {};
                appState.categories = catsSnap.val() || [];
                appState.tags = tagsSnap.val() || [];
                renderArticleGrid();
            } catch (err) { showError('Ë≥áÊñôËºâÂÖ•Â§±Êïó: ' + err.message); }
        }
        
        function renderArticleGrid(filter = '') {
            const term = filter.toLowerCase();
            const filteredArticles = Object.entries(appState.articles).filter(([,a]) => (a.title + (a.content||'') + (a.tags||[]).join('')).toLowerCase().includes(term));
            
            ui.articleGrid.innerHTML = filteredArticles.sort(([,a],[,b]) => new Date(b.date) - new Date(a.date)).map(([id, article]) => {
                const tagsHtml = (article.tags || []).map(tagName => {
                    const tag = appState.tags.find(t => t.name === tagName);
                    return `<span class="tag" style="background-color:${tag?.color || '#6c757d'}">${tagName}</span>`;
                }).join('');
                return `
                <article class="article-card" data-id="${id}">
                    <img src="${article.coverImage || ''}" class="card-cover" onerror="this.style.display='none'">
                    <div class="card-content">
                        <h3 class="card-title">${article.title}</h3>
                        <div class="tags">${tagsHtml}</div>
                    </div>
                </article>`;
            }).join('') || '<p>Ê≤íÊúâÊñáÁ´†</p>';
        }
        
        async function renderArticleView(id) {
            const article = appState.articles[id];
            if (!article) return;
            
            // Increment View Count
            if (!sessionStorage.getItem(`viewed_${id}`)) {
                await update(ref(db, `articles/${id}`), { viewCount: increment(1) });
                article.viewCount = (article.viewCount || 0) + 1;
                sessionStorage.setItem(`viewed_${id}`, 'true');
            }
            
            const likeIconSvg = (isLiked) => `
                <svg class="like-icon ${isLiked ? 'liked' : 'unliked'}" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
            
            ui.articleView.innerHTML = `
                <article class="article-container">
                    <img src="${article.coverImage || ''}" class="article-header-image" onerror="this.style.display='none'">
                    <h1 class="article-title">${article.title}</h1>
                    <div class="article-meta-info">
                        <div>üë§ Kai</div>
                        <div>üìÖ ${article.date}</div>
                        <div>‚è≥ ${calculateReadingTime(article.content)}</div>
                        <div>üëÅÔ∏è ${article.viewCount || 1}</div>
                        <div id="like-container" data-id="${id}">${likeIconSvg(false)}<span id="like-count">0</span></div>
                    </div>
                    <div class="article-content">${marked.parse(article.content || '')}</div>
                </article>
                <nav class="article-bottom-nav"><button id="back-btn" class="btn">ËøîÂõûÂàóË°®</button></nav>
                <div class="comment-section">
                     <h3 class="comment-header"><span id="comment-count">0</span> ÂâáÁïôË®Ä</h3>
                     <div class="comment-form-container">
                        <div class="comment-avatar">Êàë</div>
                        <div class="comment-input-area">
                           <form id="comment-form" data-id="${id}">
                              <input id="comment-author-input" type="hidden" value="Êàë">
                              <input id="comment-text-input" class="comment-input" placeholder="Êñ∞Â¢ûÁïôË®Ä..." required>
                              <div style="text-align:right;"><button type="submit" class="btn">ÁïôË®Ä</button></div>
                           </form>
                        </div>
                     </div>
                     <div id="comment-list"></div>
                </div>`;
            
            ui.homeView.classList.remove('active');
            ui.articleView.classList.add('active');
            window.scrollTo(0,0);
            updateLikeAndCommentView(id); // Initial load
        }

        async function updateLikeAndCommentView(id) {
            // Likes
            const likesSnap = await get(ref(db, `likes/${id}`));
            const likes = likesSnap.val() || {};
            const userKey = localStorage.getItem('userKey');
            const isLiked = userKey && likes[userKey];
            document.getElementById('like-container').innerHTML = `${document.querySelector('.like-icon').outerHTML.replace(/class="[^"]*"/, `class="like-icon ${isLiked ? 'liked' : 'unliked'}"`)} <span id="like-count">${Object.keys(likes).length}</span>`;

            // Comments
            const commentsSnap = await get(ref(db, `comments/${id}`));
            const comments = commentsSnap.val() || {};
            document.getElementById('comment-count').textContent = Object.keys(comments).length;
            document.getElementById('comment-list').innerHTML = Object.values(comments).sort((a,b)=>b.timestamp-a.timestamp).map(c=>`
            <div class="comment">
                <div class="comment-avatar">${(c.author || 'A')[0]}</div>
                <div class="comment-content">
                    <span class="author">${c.author}</span><span class="timestamp">${new Date(c.timestamp).toLocaleString()}</span>
                    <p>${c.text}</p>
                </div>
            </div>`).join('');
        }
        
        async function openEditor(id = null) {
            const article = id ? appState.articles[id] : {};
            ui.editorOverlay.innerHTML = `
                <div class="modal">
                    <input type="hidden" id="editor-id" value="${id || ''}">
                    <input id="editor-title" value="${article.title || ''}" placeholder="Ê®ôÈ°å">
                    <input id="editor-date" type="date" value="${article.date || new Date().toISOString().slice(0,10)}">
                    <!-- ... inputs for category, cover, tags ... -->
                    <div id="editor-container" style="flex-grow:1;"></div>
                    <button id="save-btn">ÂÑ≤Â≠ò</button> <button id="delete-btn" style="${id ? '' : 'display:none;'}">Âà™Èô§</button>
                </div>`;
            ui.editorOverlay.style.display = 'flex';
            
            editor = new toastui.Editor({
                el: document.getElementById('editor-container'), initialEditType: 'markdown', previewStyle: 'vertical',
                initialValue: article.content || ''
            });
        }
        
        async function saveArticle() {
            const id = document.getElementById('editor-id').value || `post_${Date.now()}`;
            const articleData = {
                title: document.getElementById('editor-title').value,
                date: document.getElementById('editor-date').value,
                content: editor.getMarkdown()
            };
            await set(ref(db, `articles/${id}`), articleData);
            ui.editorOverlay.style.display = 'none';
            loadData();
        }

        async function deleteArticle() {
            const id = document.getElementById('editor-id').value;
            if (id && confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁØáÊñáÁ´†ÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                await remove(ref(db, `articles/${id}`));
                await remove(ref(db, `likes/${id}`)); // Also delete associated data
                await remove(ref(db, `comments/${id}`));
                ui.editorOverlay.style.display = 'none';
                loadData();
            }
        }
        
        // --- Event Listeners ---
        ui.siteTitle.addEventListener('click', () => { ui.articleView.classList.remove('active'); ui.homeView.classList.add('active'); renderArticleGrid(); });
        ui.themeToggle.addEventListener('click', () => document.body.classList.toggle('dark-mode'));
        ui.searchInput.addEventListener('input', (e) => renderArticleGrid(e.target.value));
        ui.articleGrid.addEventListener('click', e => { const id = e.target.closest('.article-card')?.dataset.id; if(id) renderArticleView(id); });
        
        // Delegated listeners for dynamic content
        document.addEventListener('click', e => {
            if (e.target.closest('#back-btn')) { ui.articleView.classList.remove('active'); ui.homeView.classList.add('active'); renderArticleGrid(); }
            if (e.target.closest('#like-container')) {
                let userKey = localStorage.getItem('userKey');
                if (!userKey) { userKey = `user_${Date.now()}`; localStorage.setItem('userKey', userKey); }
                const id = e.target.closest('#like-container').dataset.id;
                const likeRef = ref(db, `likes/${id}/${userKey}`);
                const isLiked = document.querySelector('.like-icon.liked');
                (isLiked) ? remove(likeRef).then(() => updateLikeAndCommentView(id)) : set(likeRef, true).then(() => updateLikeAndCommentView(id));
            }
            if(e.target.id === "save-btn") saveArticle();
            if(e.target.id === "delete-btn") deleteArticle();
        });
        
        document.addEventListener('submit', e => {
            if (e.target.id === 'comment-form') {
                e.preventDefault();
                const id = e.target.dataset.id;
                const text = document.getElementById('comment-text-input').value.trim();
                if(text) {
                    set(ref(db, `comments/${id}/${Date.now()}`), { author: "Êàë", text, timestamp: Date.now() })
                    .then(() => { e.target.reset(); updateLikeAndCommentView(id); });
                }
            }
        });

        // --- Admin Mode ---
        ui.manageBtn.addEventListener('click', () => {
            ui.mgmtOverlay.style.display = 'flex';
            // Here you would render the management views for tags/cats
        });
        ui.newArticleBtn.addEventListener('click', () => openEditor());

        // Simple password auth for edit mode
        let attemptCount = 0;
        document.querySelector('footer').addEventListener('click', () => {
            if (appState.isEditMode) return;
            const pass = prompt('Enter admin password:');
            if (pass === "980621") {
                appState.isEditMode = true;
                document.body.classList.add('admin-mode');
                ui.manageBtn.style.display = 'inline-block';
                ui.newArticleBtn.style.display = 'inline-block';
                alert('Admin mode activated.');
            } else if (pass) {
                attemptCount++;
                if (attemptCount > 2) alert('Too many failed attempts.');
                else alert('Incorrect password.');
            }
        });

        // --- Initial Load ---
        loadData();
    </script>
</body>
</html>
